<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- SEO Optimization -->
    <title>Cell Soul | Interactive Mammatus Cloud Simulator</title>
    <meta name="description" content="Cell Soul is an immersive, real-time procedural simulator of Mammatus clouds. Explore organic atmospheric formations through cellular noise, domain warping, and dynamic lighting controls directly in your browser.">
    <meta name="keywords" content="Cell Soul, Mammatus clouds, cloud simulator, procedural generation, atmospheric simulation, Three.js, WebGL, digital art, interactive sky">
    <link rel="canonical" href="https://pirillo.com/arcade/cell-soul.html">
    <meta name="author" content="Chris Pirillo">

    <!-- Social Media Meta Tags (Open Graph) -->
    <meta property="og:title" content="Cell Soul | Interactive Mammatus Cloud Simulator">
    <meta property="og:description" content="Experience a real-time procedural simulation of rare Mammatus cloud formations with customizable atmospheric parameters.">
    <meta property="og:image" content="https://pirillo.com/arcade/images/cell-soul.png">
    <meta property="og:url" content="https://pirillo.com/arcade/cell-soul.html">
    <meta property="og:type" content="website">

    <!-- Twitter Card Data -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@ChrisPirillo">
    <meta name="twitter:creator" content="@ChrisPirillo">
    <meta name="twitter:title" content="Cell Soul | Interactive Mammatus Cloud Simulator">
    <meta name="twitter:description" content="A stunning WebGL simulation of atmospheric Mammatus clouds. Adjust density, light, and scale to create unique sky vistas.">
    <meta name="twitter:image" content="https://pirillo.com/arcade/images/cell-soul.png">

    <!-- Resource Hints -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">

    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Cell Soul",
      "url": "https://pirillo.com/arcade/cell-soul.html",
      "description": "An interactive WebGL application that simulates the formation and movement of Mammatus clouds using procedural noise and custom shaders.",
      "applicationCategory": "MultimediaApplication",
      "operatingSystem": "Any",
      "author": {
        "@type": "Person",
        "name": "Chris Pirillo",
        "url": "https://pirillo.com/"
      },
      "image": "https://pirillo.com/arcade/images/cell-soul.png",
      "featureList": "Real-time procedural cloud generation, interactive lighting controls, 4K wallpaper export, auto-cycling animation."
    }
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1CQ4D3VQ3L"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-1CQ4D3VQ3L');
    </script>

    <!-- Performance: Defer non-critical Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <style>
        /* Performance: font-display: swap to prevent layout shift/invisible text */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap&font-display=swap');

        :root {
            --bg-panel: rgba(15, 23, 42, 0.65);
            --bg-panel-solid: #0f172a;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --accent: #38bdf8;
            --accent-glow: rgba(56, 189, 248, 0.3);
            --border: rgba(255, 255, 255, 0.08);
            --input-bg: rgba(0, 0, 0, 0.3);
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            user-select: none;
            -webkit-user-select: none;
            -webkit-font-smoothing: antialiased;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            cursor: crosshair;
        }

        #fade-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 50;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }

        #ui-toggle {
            position: absolute;
            top: 24px;
            right: 24px;
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            border: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        #ui-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            border-color: rgba(255,255,255,0.2);
        }

        #ui-toggle svg {
            width: 24px;
            height: 24px;
            fill: var(--text-main);
            transition: transform 0.3s ease;
        }
        
        #ui-toggle:hover svg {
            transform: rotate(90deg);
        }

        #settings-panel {
            position: absolute;
            top: 0;
            right: 0;
            width: 360px;
            height: 100%;
            background: var(--bg-panel);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 90;
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: -20px 0 50px rgba(0,0,0,0.5);
        }

        #settings-panel.open {
            transform: translateX(0);
        }

        .panel-header {
            padding: 32px 24px 24px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .panel-header h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
            color: var(--text-main);
            letter-spacing: -0.02em;
        }
        
        .panel-header span {
            display: block;
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
            font-weight: 400;
        }

        .close-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text-main);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 0 24px 40px;
        }

        .panel-content::-webkit-scrollbar { width: 4px; }
        .panel-content::-webkit-scrollbar-track { background: transparent; }
        .panel-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

        .section-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent);
            margin-top: 32px;
            margin-bottom: 16px;
            font-weight: 600;
            opacity: 0.9;
        }
        
        .control-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .control-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .label-main {
            font-size: 13px;
            color: var(--text-main);
            font-weight: 500;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 50%;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--text-main);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            margin-top: -7px;
        }
        
        .val-display {
            font-size: 12px;
            color: var(--text-muted);
            width: 32px;
            text-align: right;
            font-feature-settings: "tnum";
        }

        .color-wrapper {
            position: relative;
            width: 100%;
            height: 36px;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid var(--border);
        }

        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 150%;
            height: 150%;
            position: absolute;
            top: -25%;
            left: -25%;
            cursor: pointer;
        }

        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 4px 0;
        }

        .toggle-switch {
            width: 44px;
            height: 24px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            position: relative;
            transition: all 0.3s;
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px; left: 2px;
            width: 18px; height: 18px;
            background: var(--text-muted);
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .toggle-active .toggle-switch { background: var(--accent-glow); }
        .toggle-active .toggle-switch::after { transform: translateX(20px); background: var(--accent); }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }
        
        .btn-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 14px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s;
        }

        .btn-primary { 
            background: var(--accent); 
            color: #0f172a; 
            border: none;
        }

        .tooltip {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 500;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--border);
            z-index: 60;
        }
    </style>
</head>
<body>

    <div id="fade-overlay"></div>

    <main id="canvas-container">
        <!-- Visual Content -->
    </main>

    <div class="tooltip" id="click-tooltip">Tap screen to Randomize</div>

    <header id="ui-toggle" aria-label="Open Settings">
        <svg viewBox="0 0 24 24">
            <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </header>

    <section id="settings-panel" aria-labelledby="panel-title">
        <div class="panel-header">
            <div>
                <h2 id="panel-title">Cell Soul Controls</h2>
                <span>Mammatus Simulation</span>
            </div>
            <button class="close-btn" aria-label="Close Settings">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        
        <div class="panel-content">
            
            <div class="section-title">Formation</div>
            <div class="control-card">
                <div class="control-row">
                    <label class="label-main" for="scale">Cloud Scale</label>
                    <input type="range" id="scale" min="1" max="15" step="0.1" aria-valuemin="1" aria-valuemax="15">
                    <span class="val-display" id="val-scale"></span>
                </div>
                <div class="control-row">
                    <label class="label-main" for="cover">Cloud Density</label>
                    <input type="range" id="cover" min="0.3" max="0.8" step="0.01" aria-valuemin="0.3" aria-valuemax="0.8">
                    <span class="val-display" id="val-cover"></span>
                </div>
                <div class="control-row">
                    <label class="label-main" for="warp">Distortion</label>
                    <input type="range" id="warp" min="0" max="1.0" step="0.01" aria-valuemin="0" aria-valuemax="1.0">
                    <span class="val-display" id="val-warp"></span>
                </div>
                 <div class="control-row">
                    <label class="label-main" for="roundness">Roundness</label>
                    <input type="range" id="roundness" min="0.1" max="0.5" step="0.01" aria-valuemin="0.1" aria-valuemax="0.5">
                    <span class="val-display" id="val-roundness"></span>
                </div>
                <div class="control-row">
                    <label class="label-main" for="bump">Pouch Depth</label>
                    <input type="range" id="bump" min="0.1" max="3.0" step="0.1" aria-valuemin="0.1" aria-valuemax="3.0">
                    <span class="val-display" id="val-bump"></span>
                </div>
                <div class="control-row">
                    <label class="label-main" for="noise">Detail Noise</label>
                    <input type="range" id="noise" min="0" max="1" step="0.01" aria-valuemin="0" aria-valuemax="1">
                    <span class="val-display" id="val-noise"></span>
                </div>
            </div>

            <div class="section-title">Atmosphere & Light</div>
            <div class="control-card">
                <div class="control-row">
                    <label class="label-main" for="lightX">Sun Position X</label>
                    <input type="range" id="lightX" min="-1" max="1" step="0.01" aria-valuemin="-1" aria-valuemax="1">
                    <span class="val-display" id="val-lightX"></span>
                </div>
                <div class="control-row">
                    <label class="label-main" for="lightY">Sun Position Y</label>
                    <input type="range" id="lightY" min="-1" max="1" step="0.01" aria-valuemin="-1" aria-valuemax="1">
                    <span class="val-display" id="val-lightY"></span>
                </div>
                <div class="control-row">
                    <label class="label-main" for="specular">Shininess</label>
                    <input type="range" id="specular" min="0" max="2" step="0.1" aria-valuemin="0" aria-valuemax="2">
                    <span class="val-display" id="val-specular"></span>
                </div>
            </div>

            <div class="section-title">Palette</div>
            <div class="control-card" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <div style="text-align: center;">
                    <div class="color-wrapper">
                        <input type="color" id="colBase" aria-label="Base Color">
                    </div>
                    <span style="font-size: 11px; color: var(--text-muted); display: block; margin-top: 6px;">Base</span>
                </div>
                <div style="text-align: center;">
                    <div class="color-wrapper">
                        <input type="color" id="colHigh" aria-label="Highlight Color">
                    </div>
                    <span style="font-size: 11px; color: var(--text-muted); display: block; margin-top: 6px;">Highlight</span>
                </div>
                <div style="text-align: center;">
                    <div class="color-wrapper">
                        <input type="color" id="colAmbient" aria-label="Ambient Color">
                    </div>
                    <span style="font-size: 11px; color: var(--text-muted); display: block; margin-top: 6px;">Ambient</span>
                </div>
            </div>

            <div class="section-title">Animation</div>
            <div class="control-card">
                <div class="control-row">
                    <label class="label-main" for="speed">Flow Speed</label>
                    <input type="range" id="speed" min="0" max="2" step="0.1" aria-valuemin="0" aria-valuemax="2">
                    <span class="val-display" id="val-speed"></span>
                </div>
                
                <div style="height: 1px; background: var(--border); margin: 12px 0;"></div>

                <div class="toggle-row" id="auto-advance-toggle" role="checkbox" aria-checked="false" tabindex="0">
                    <div class="label-group">
                        <span class="label-main">Auto-Cycle</span>
                        <span style="font-size: 11px; color: var(--text-muted);">Randomize automatically</span>
                    </div>
                    <div class="toggle-switch"></div>
                </div>
                
                <div class="control-row" style="margin-top: 16px;">
                    <label class="label-main" for="interval">Cycle Interval (s)</label>
                    <input type="range" id="interval" min="2" max="30" step="1" aria-valuemin="2" aria-valuemax="30">
                    <span class="val-display" id="val-interval"></span>
                </div>
            </div>

            <div class="btn-group">
                <div class="btn-row">
                    <button class="btn" id="btn-random">Randomize</button>
                    <button class="btn" id="btn-reset">Reset</button>
                </div>
                <button class="btn btn-primary" id="btn-export">Export 4K Wallpaper</button>
            </div>

        </div>
    </section>

    <!-- GLSL Shaders -->
    <script id="vertexShader" type="x-shader/x-vertex">
        varying vec2 vUv;
        void main() {
            vUv = uv;
            gl_Position = vec4(position, 1.0);
        }
    </script>

    <script id="fragmentShader" type="x-shader/x-fragment">
        uniform float uTime;
        uniform vec2 uResolution;
        uniform float uScale;
        uniform float uBump;
        uniform float uNoiseStr;
        uniform float uCover;
        uniform float uSpecStr;
        uniform float uWarp;
        uniform float uRoundness;
        uniform vec3 uLightDir;
        uniform vec3 uColorBase;
        uniform vec3 uColorHigh;
        uniform vec3 uColorAmbient;

        varying vec2 vUv;

        vec2 hash2(vec2 p) {
            p = vec2(dot(p, vec2(127.1, 311.7)), dot(p, vec2(269.5, 183.3)));
            return -1.0 + 2.0 * fract(sin(p) * 43758.5453123);
        }

        float noise(vec2 p) {
            const float K1 = 0.366025404;
            const float K2 = 0.211324865;
            vec2 i = floor(p + (p.x + p.y) * K1);
            vec2 a = p - i + (i.x + i.y) * K2;
            vec2 o = (a.x > a.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
            vec2 b = a - o + K2;
            vec2 c = a - 1.0 + 2.0 * K2;
            vec3 h = max(0.5 - vec3(dot(a, a), dot(b, b), dot(c, c)), 0.0);
            vec3 n = h * h * h * h * vec3(dot(a, hash2(i + 0.0)), dot(b, hash2(i + o)), dot(c, hash2(i + 1.0)));
            return dot(n, vec3(70.0));
        }

        float cellular(vec2 p) {
            vec2 i = floor(p);
            vec2 f = fract(p);
            float min_dist = 1.0;
            
            for (int y = -1; y <= 1; y++) {
                for (int x = -1; x <= 1; x++) {
                    vec2 neighbor = vec2(float(x), float(y));
                    vec2 point = hash2(i + neighbor);
                    point = 0.5 + 0.5 * sin(uTime * 0.05 + 6.2831 * point);
                    vec2 diff = neighbor + point - f;
                    float dist = length(diff);
                    min_dist = min(min_dist, dist);
                }
            }
            return min_dist;
        }

        float getHeight(vec2 uv) {
            vec2 warp = vec2(
                noise(uv * 0.8 + uTime * 0.02),
                noise(uv * 0.8 + 10.0 + uTime * 0.03)
            ) * uWarp;
            
            vec2 distortedUV = uv * uScale + warp;
            float c = cellular(distortedUV);
            c = pow(clamp(c, 0.0, 1.0), uRoundness);
            float threshold = 1.0 - uCover;
            float h = smoothstep(threshold - 0.2, threshold + 0.2, 1.0 - c);
            float n = noise(uv * uScale * 2.0 + vec2(uTime * 0.05));
            return mix(h, h + n * 0.15, uNoiseStr) * uBump;
        }

        void main() {
            vec2 uv = vUv;
            vec2 aspectUv = uv;
            aspectUv.x *= uResolution.x / uResolution.y;

            float h = getHeight(aspectUv);
            vec2 e = vec2(0.015, 0.0);
            float hx = getHeight(aspectUv + e.xy) - getHeight(aspectUv - e.xy);
            float hy = getHeight(aspectUv + e.yx) - getHeight(aspectUv - e.yx);
            vec3 normal = normalize(vec3(-hx, -hy, e.x * 3.0));

            vec3 lightDir = normalize(vec3(uLightDir.x, uLightDir.y, 1.0));
            float diff = max(dot(normal, lightDir), 0.0);
            diff = pow(diff, 1.4);
            
            vec3 viewDir = vec3(0.0, 0.0, 1.0);
            vec3 reflectDir = reflect(-lightDir, normal);
            float spec = pow(max(dot(viewDir, reflectDir), 0.0), 12.0) * uSpecStr;

            float sss = smoothstep(-0.6, 0.4, dot(lightDir, -normal));
            sss = pow(sss, 2.0) * 0.7;

            vec3 finalColor = mix(uColorBase, uColorAmbient, h * 0.7 + 0.1); 
            finalColor += uColorHigh * diff * 0.6; 
            finalColor += uColorHigh * spec * 0.4; 
            finalColor += uColorHigh * sss * 0.5;

            float vig = 1.0 - smoothstep(0.3, 1.5, length(uv - 0.5));
            finalColor *= vig;
            finalColor = pow(finalColor, vec3(0.4545));
            gl_FragColor = vec4(finalColor, 1.0);
        }
    </script>

    <script>
        /* CRITICAL: Scripts must wait for Three.js to load via the window onload event or similar */
        window.addEventListener('load', function() {
            // Configuration & State
            const config = {
                scale: 4.0,
                bump: 1.0,
                noise: 0.1,
                cover: 0.65,
                specular: 0.3,
                warp: 0.5,
                roundness: 0.3,
                lightX: 0.5,
                lightY: 0.5,
                colBase: '#1a2b3c',
                colHigh: '#ffaa66',
                colAmbient: '#442244',
                speed: 0.3,
                autoAdvance: false,
                interval: 5
            };

            const defaultconfig = { ...config };
            let autoAdvanceTimer = null;
            let lastAutoAdvanceTime = 0;

            // Three.js Setup
            const container = document.getElementById('canvas-container');
            const scene = new THREE.Scene();
            const camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1);
            const renderer = new THREE.WebGLRenderer({ antialias: false, preserveDrawingBuffer: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            container.appendChild(renderer.domElement);

            const geometry = new THREE.PlaneGeometry(2, 2);
            
            const uniforms = {
                uTime: { value: 0 },
                uResolution: { value: new THREE.Vector2(window.innerWidth, window.innerHeight) },
                uScale: { value: config.scale },
                uBump: { value: config.bump },
                uNoiseStr: { value: config.noise },
                uCover: { value: config.cover },
                uSpecStr: { value: config.specular },
                uWarp: { value: config.warp },
                uRoundness: { value: config.roundness },
                uLightDir: { value: new THREE.Vector3(config.lightX, config.lightY, 1.0) },
                uColorBase: { value: new THREE.Color(config.colBase) },
                uColorHigh: { value: new THREE.Color(config.colHigh) },
                uColorAmbient: { value: new THREE.Color(config.colAmbient) }
            };

            const material = new THREE.ShaderMaterial({
                uniforms: uniforms,
                vertexShader: document.getElementById('vertexShader').textContent,
                fragmentShader: document.getElementById('fragmentShader').textContent
            });

            const plane = new THREE.Mesh(geometry, material);
            scene.add(plane);

            function resize() {
                renderer.setSize(window.innerWidth, window.innerHeight);
                uniforms.uResolution.value.set(window.innerWidth, window.innerHeight);
            }
            window.addEventListener('resize', resize);

            function updateUniforms() {
                uniforms.uScale.value = config.scale;
                uniforms.uBump.value = config.bump;
                uniforms.uNoiseStr.value = config.noise;
                uniforms.uCover.value = config.cover;
                uniforms.uSpecStr.value = config.specular;
                uniforms.uWarp.value = config.warp;
                uniforms.uRoundness.value = config.roundness;
                uniforms.uLightDir.value.set(config.lightX, config.lightY, 1.0);
                uniforms.uColorBase.value.set(config.colBase);
                uniforms.uColorHigh.value.set(config.colHigh);
                uniforms.uColorAmbient.value.set(config.colAmbient);
            }

            function generateRandomPalette() {
                let baseHue = Math.random();
                if (baseHue > 0.25 && baseHue < 0.45) baseHue += 0.2;
                const isNight = Math.random() > 0.6;
                let baseCol, highCol, ambientCol;

                if (isNight) {
                    baseCol = new THREE.Color().setHSL(baseHue, 0.4 + Math.random() * 0.4, 0.05 + Math.random() * 0.15);
                    highCol = new THREE.Color().setHSL(baseHue + 0.05, 0.2, 0.3 + Math.random() * 0.3);
                    ambientCol = new THREE.Color().setHSL((baseHue + 0.5) % 1.0, 0.3, 0.05);
                } else {
                    const saturation = 0.3 + Math.random() * 0.5;
                    baseCol = new THREE.Color().setHSL(baseHue, saturation, 0.15 + Math.random() * 0.25);
                    let highHue = baseHue;
                    if (baseHue > 0.5 && baseHue < 0.75) { highHue = 0.05 + Math.random() * 0.1; } 
                    else { highHue = (baseHue + 0.1) % 1.0; }
                    highCol = new THREE.Color().setHSL(highHue, 0.8, 0.6 + Math.random() * 0.3);
                    ambientCol = new THREE.Color().setHSL((baseHue + 0.5) % 1.0, 0.2, 0.15 + Math.random() * 0.15);
                }
                return { base: '#' + baseCol.getHexString(), high: '#' + highCol.getHexString(), ambient: '#' + ambientCol.getHexString() };
            }
            
            function randomizeParams(skipTransition = false) {
                if (!skipTransition) triggerTransition();
                const applyChanges = () => {
                    const palette = generateRandomPalette();
                    config.colBase = palette.base;
                    config.colHigh = palette.high;
                    config.colAmbient = palette.ambient;
                    config.scale = 3.0 + Math.random() * 5.0;
                    config.bump = 0.5 + Math.random() * 1.5;
                    config.noise = Math.random() * 0.25;
                    config.cover = 0.55 + Math.random() * 0.25;
                    config.specular = Math.random() * 0.6;
                    config.warp = 0.2 + Math.random() * 0.4;
                    config.roundness = 0.1 + Math.random() * 0.4;
                    config.lightX = (Math.random() - 0.5) * 2;
                    config.lightY = (Math.random() - 0.5) * 2;
                    config.speed = 0.2 + Math.random() * 0.4;
                    updateUIControls();
                    updateUniforms();
                };
                if (skipTransition) { applyChanges(); } 
                else { setTimeout(applyChanges, 400); }
            }

            function triggerTransition() {
                const overlay = document.getElementById('fade-overlay');
                overlay.style.opacity = 1;
                setTimeout(() => { overlay.style.opacity = 0; }, 500);
            }

            function exportWallpaper() {
                const width = 3840; const height = 2160;
                renderer.setSize(width, height);
                uniforms.uResolution.value.set(width, height);
                renderer.render(scene, camera);
                const link = document.createElement('a');
                link.download = `cell_soul_sky_${Date.now()}.png`;
                link.href = renderer.domElement.toDataURL('image/png');
                link.click();
                resize();
                renderer.render(scene, camera);
            }

            // UI Handling
            const uiPanel = document.getElementById('settings-panel');
            const uiToggle = document.getElementById('ui-toggle');
            const closeBtn = document.querySelector('.close-btn');
            const tooltip = document.getElementById('click-tooltip');
            let isMenuOpen = false;

            function toggleMenu(open) {
                isMenuOpen = open;
                if (open) {
                    uiPanel.classList.add('open');
                    uiToggle.style.transform = 'scale(0.8)';
                    uiToggle.style.opacity = 0;
                    uiToggle.style.pointerEvents = 'none';
                    tooltip.style.opacity = 0;
                } else {
                    uiPanel.classList.remove('open');
                    uiToggle.style.transform = 'scale(1)';
                    uiToggle.style.opacity = 1;
                    uiToggle.style.pointerEvents = 'auto';
                    setTimeout(() => tooltip.style.opacity = 1, 1000);
                }
            }

            uiToggle.addEventListener('click', (e) => { e.stopPropagation(); toggleMenu(true); });
            closeBtn.addEventListener('click', () => toggleMenu(false));

            document.addEventListener('click', (e) => {
                if (isMenuOpen) {
                    if (!uiPanel.contains(e.target) && e.target !== uiToggle) { toggleMenu(false); }
                } else {
                    if (e.target.tagName === 'CANVAS' || e.target.id === 'canvas-container') {
                        randomizeParams(); resetAutoAdvance();
                    }
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && isMenuOpen) toggleMenu(false);
            });

            setTimeout(() => {
                tooltip.style.opacity = 1;
                setTimeout(() => { if(!isMenuOpen) tooltip.style.opacity = 0; }, 4000);
            }, 1000);

            function bindInput(id, configKey, isColor = false) {
                const el = document.getElementById(id);
                const disp = document.getElementById('val-' + id);
                el.addEventListener('input', (e) => {
                    config[configKey] = isColor ? e.target.value : parseFloat(e.target.value);
                    if (disp) disp.innerText = config[configKey];
                    updateUniforms(); resetAutoAdvance();
                });
            }

            bindInput('scale', 'scale');
            bindInput('cover', 'cover');
            bindInput('bump', 'bump');
            bindInput('noise', 'noise');
            bindInput('warp', 'warp');
            bindInput('roundness', 'roundness');
            bindInput('lightX', 'lightX');
            bindInput('lightY', 'lightY');
            bindInput('specular', 'specular');
            bindInput('speed', 'speed');
            bindInput('interval', 'interval');
            bindInput('colBase', 'colBase', true);
            bindInput('colHigh', 'colHigh', true);
            bindInput('colAmbient', 'colAmbient', true);

            const toggleRow = document.getElementById('auto-advance-toggle');
            toggleRow.addEventListener('click', () => {
                config.autoAdvance = !config.autoAdvance;
                toggleRow.classList.toggle('toggle-active', config.autoAdvance);
                toggleRow.setAttribute('aria-checked', config.autoAdvance);
                resetAutoAdvance();
            });

            document.getElementById('btn-random').addEventListener('click', () => randomizeParams());
            document.getElementById('btn-reset').addEventListener('click', () => {
                triggerTransition();
                setTimeout(() => {
                    Object.assign(config, defaultconfig);
                    updateUIControls(); updateUniforms(); resetAutoAdvance();
                }, 400);
            });
            document.getElementById('btn-export').addEventListener('click', exportWallpaper);

            function updateUIControls() {
                document.getElementById('scale').value = config.scale;
                document.getElementById('val-scale').innerText = config.scale.toFixed(1);
                document.getElementById('cover').value = config.cover;
                document.getElementById('val-cover').innerText = config.cover.toFixed(2);
                document.getElementById('warp').value = config.warp;
                document.getElementById('val-warp').innerText = config.warp.toFixed(2);
                document.getElementById('roundness').value = config.roundness;
                document.getElementById('val-roundness').innerText = config.roundness.toFixed(1);
                document.getElementById('bump').value = config.bump;
                document.getElementById('val-bump').innerText = config.bump.toFixed(1);
                document.getElementById('noise').value = config.noise;
                document.getElementById('val-noise').innerText = config.noise.toFixed(2);
                document.getElementById('lightX').value = config.lightX;
                document.getElementById('val-lightX').innerText = config.lightX.toFixed(2);
                document.getElementById('lightY').value = config.lightY;
                document.getElementById('val-lightY').innerText = config.lightY.toFixed(2);
                document.getElementById('specular').value = config.specular;
                document.getElementById('val-specular').innerText = config.specular.toFixed(1);
                document.getElementById('speed').value = config.speed;
                document.getElementById('val-speed').innerText = config.speed.toFixed(1);
                document.getElementById('interval').value = config.interval;
                document.getElementById('val-interval').innerText = config.interval;
                document.getElementById('colBase').value = config.colBase;
                document.getElementById('colHigh').value = config.colHigh;
                document.getElementById('colAmbient').value = config.colAmbient;
                toggleRow.classList.toggle('toggle-active', config.autoAdvance);
            }

            function resetAutoAdvance() { lastAutoAdvanceTime = performance.now(); }

            function animate(time) {
                requestAnimationFrame(animate);
                uniforms.uTime.value += 0.01 * config.speed;
                if (config.autoAdvance) {
                    if (time - lastAutoAdvanceTime > config.interval * 1000) {
                        randomizeParams(); lastAutoAdvanceTime = time;
                    }
                } else { lastAutoAdvanceTime = time; }
                renderer.render(scene, camera);
            }

            randomizeParams(true);
            animate(0);
        });
    </script>
</body>
</html>